<!-- Extending the predefined project layout -->
{% extends "layouts/base.html" %}

<!- This variable sets name of browser tab  -->
{% set project = "Economy x Weather Simulation" %}

<!- This is a replacement block for Body in base.html -->
{% block body %}
<!- Try building a new body here ->

<!-- Bug Fix Board (Preferable Ordered by importance / occurrence

Issue #2 : No idea how to draw interpolated points onto ASCII graph
    Resolved: No

-->

<!-- Bug graveyard (Copy-paste bug info for future reminiscence ability)

Issue #1 : When dragging one window onto another, windows bug out due to both trying to be dragged (Make only one draggable at a time)
    Resolved: Yes


-->
<style>
    :root {
        --sView_xPos: 90px;
        --sView_yPos: 90px;

        --sEx_xPos: 900px;
        --sEx_yPos: 90px;

        --sExW_zIndex: 1;
        --sGrW_zIndex: auto;
    }
    .stockGraph {
        padding-left: 8px;
        line-height : 10px;
        letter-spacing: 2px;
        font-size: 14px
    }
    .stockGraphWindow {
        border: 1px solid white;
        font-family: monospace;
        width: 600px;
        height: 600px;
        text-align: left;
        position: absolute;
        margin-left: var(--sView_xPos);
        margin-top: var(--sView_yPos);
        z-index: var(--sGrW_zIndex);
        background-color: black;
        /* background: none; /* Testing purposes */
    }

    .stockExchangeWindow {
        border: 1px solid white;
        font-family: monospace;
        width: 600px;
        height: 600px;
        text-align: left;
        position: absolute;
        margin-left: var(--sEx_xPos);
        margin-top: var(--sEx_yPos);
        z-index: var(--sExW_zIndex);
        background-color: black;
        /* background: none; /* Testing purposes */
    }

    .windowNavbar {
        font-family: monospace;
        background-color: white;
        color: black;
    }


    .bg {
        background-color: rgb(1,130,129);
        width: 100%;
        height: 100%;
        position: absolute;
        overflow: hidden; /* Fixed Scroll amount */
        user-select: none; /* Disables text highlighting */
    }



</style>

<div class="bg">

    <div class="stockGraphWindow">
        <p class="windowNavbar">Stock Viewer</p>

        <!-- Graph -->
        <p class="stockGraph" id="stockGraphData">error</p>

    </div>

    <div class="stockExchangeWindow">
        <p class="windowNavbar">Stock Exchanger</p>
    </div>


    <p class="test0" id="test0">null</p> <!-- Used for verifying the game loop is running-->
    <p class="test0" id="test6">null</p> <!-- Used for time-->
    <p class="test0" id="test1">null</p> <!-- Used for verifying mouse action-->
    <p class="test0" id="test2">null</p> <!-- Used for verifying mouse movement-->
    <p class="test0" id="test3">null</p> <!-- Used for testing with an array-->
    <p class="test0" id="test4">null</p> <!-- Used for testing with an array-->
    <p class="test0" id="test5">null</p> <!-- Used for testing with an array-->
    <p class="test0" id="test7">null</p> <!-- Used for testing with an array-->
    <p class="test0" id="test8">null</p> <!-- Used for testing with an array-->
</div>


<script>
    // Declare functions and variables

    let ticks = 0 // To prove the loop is running
    let hour = 0 // To prove the loop is running
    let test69 = 0

    let seed = Math.random() // Starting seed to seed everything else

    let sViewX = 90; let sViewY = 90; // Declares stockViewer position
    let sExX = 900; let sExY = 90; // Declares stockExchanger position
    let mouseDown = [0, 0, 0, 0, 0, 0, 0, 0, 0]; let mouseDownCount = 0; let mouseX = 0; let mouseY = 0; // Declare mouse variables
    let navbarHeight = 90 // Represent pixel width of navbar
    let sVeXMouseGap = 0; let sVeYMouseGap = 0; // Gap between stock viewer and mouse
    let sExXMouseGap = 0; let sExYMouseGap = 0; // Gap between stock exchanger and mouse
    let windowDragged = 0; // Used for determining which window is being currently dragged
    let sExZ = 1; let sGrZ = 0; // Stores windows Z Index
    let stockGraphData = ""; // Declares stockGraphData
    let stockGraphSize = 50; // Graph Size

    let stockCount = 4; // Number of stocks ### IMPORTANT TO KEEP RIGHT ###
    let currentStockGraphed = 0;

    // Declaration of stock variables
    // Seed + consecutive fibonacci number please!

    let stockData = [
        ["Candy Morse", ((noise(seed + 2, 1) * 12 ) ** 2 + 9).toFixed(2), "Serving candy since white vans were a thing!"],
        ["Ramanujan's Perfect Gelato", ((noise(seed + 3, 1) * 12 ) ** 2 + 9).toFixed(2), "Replacing Frost since 2021"],
        ["Moore's Chicken", ((noise(seed + 5, 1) * 12 ) ** 2 + 9).toFixed(2), "Better than KFC!"],
        ["Jakub's Fishies", ((noise(seed + 7, 1) * 12 ) ** 2 + 9).toFixed(2), "Fishy???"]
    ];

    let stockHistory = [];

    for (let i = 0; i < stockCount; i++) {
        stockHistory.push([])
    }

    for (let y = 0; y < 50; y++) { // Creates starting randomness for the stocks (Stock History Length)
        for (let x = 0; x < stockCount; x++) { // Stock number
            stockHistory[x][y] =  100 * noise(stockData[x][1], y) //Math.round(100 * noise(1, 1))
        }
    }

    // stockData = stockData.push(["Jakub's Burgers",2]) // Example of how to create a new stock an associated information
    // stockData[3][2] = "Best Burger's ever!" // Example of how to append new information to a specific stock

    // Noise Function

    let noiseData = [];
    for (let y = 0; y < stockCount; y++){ // y = len of stock list
        noiseData.push([])
        for (let x = 0; x < 3; x++) {
            noiseData[y].push(noise(6, 1))
        }
    }

    // End of declaration

    document.addEventListener('mousemove', logMouse); // Updates mouseX and mouseY when the mouse moves

    function noise(seed, iterations) {
        let noise = seed;
        for (let i = 0; i <= iterations; i++) {
            noise = ((noise * 604211) + 667588) % 1048573
        }
        return noise / 1048572
    }

    function logMouse(e) { // Logs mouse data in e
        mouseX = e.pageX;
        mouseY = e.pageY - navbarHeight;
    }

    function detectLeftButton() {
        // On mouse down display the current mouse action in a list
        document.body.onmousedown = function(evt) {
            ++mouseDown[evt.button];
            ++mouseDownCount;
        }
        document.body.onmouseup = function(evt) {
            --mouseDown[evt.button];
            --mouseDownCount;
        }

        // When clicking multiple buttons, this code sometimes glitches. If statement resets list
        if (mouseDown[0] <= -1 || mouseDown[0] >= 2) {
            mouseDown[0] = 0
        }
    }


    function test() {
        document.getElementById('test0').innerHTML = ticks;
        document.getElementById('test6').innerHTML = hour;

        document.getElementById('test3').innerHTML = noiseData;
        document.getElementById('test4').innerHTML = stockData;
        document.getElementById('test5').innerHTML = stockHistory;
        document.getElementById('test7').innerHTML = findInterpolatedPoint(1, 2, 0.5);;
        //document.getElementById('test8').innerHTML = stockHistory;
    }
    function findInterpolatedPoint(x1, x2, x) {
        return x1 * (-3 * (x ** 2) + 2 * (x ** 3) + 1) + x2 * (3 * (x ** 2) - 2 * (x ** 3))
    }
    function updateGraphAndDisplay() {
        // y1 (-3(x) ** 2 + 2(x) ** 3 + y2 (3(x) ** 2 - 2(x) ** 3
        stockGraphData = ""
        for (let y = 0; y < stockGraphSize; y++) { // Creates starting randomness for the stocks
            for (let x = hour; x < 50 + hour; x++) {
                if (Math.floor(findInterpolatedPoint(stockHistory[currentStockGraphed][Math.floor(x)], stockHistory[currentStockGraphed][Math.ceil(x)], x) / 2) === 50 - y) { //(First is company, second is history)
                    stockGraphData = stockGraphData.concat("#")
                } else if (Math.floor(findInterpolatedPoint(stockHistory[currentStockGraphed][Math.floor(x)], stockHistory[currentStockGraphed][Math.ceil(x)], x) / 2) >= 50 - y) {
                    stockGraphData = stockGraphData.concat("=")
                } else {
                    stockGraphData = stockGraphData.concat(".")
                }

            }
            stockGraphData = stockGraphData.concat("<br>")
        }

        document.getElementById('stockGraphData').innerHTML = stockGraphData;
    }

    function updateWindowPositions() {

        // Draggable windows code
        detectLeftButton() // Gather left click info

        if (mouseDown[0] === 1) {

            if (mouseX >= sViewX && mouseX <= sViewX + 600 && mouseY >= sViewY && mouseY <= sViewY + 600 && sGrZ === 1 && windowDragged === 0 || windowDragged === 1) { // Updates drag for sView
                sViewX = mouseX - sVeXMouseGap;
                sViewY = mouseY - sVeYMouseGap;


                // Z handler
                document.documentElement.style.setProperty('--sGrW_zIndex', "1");
                sGrZ = 1
                windowDragged = 1
                document.documentElement.style.setProperty('--sExW_zIndex', "auto");
                sExZ = 0
            }

            if (mouseX >= sExX && mouseX <= sExX + 600 && mouseY >= sExY && mouseY <= sExY + 600 && sExZ === 1 && windowDragged === 0 || windowDragged === 2) { // Updates drag for sEx
                sExX = mouseX - sExXMouseGap;
                sExY = mouseY - sExYMouseGap;


                document.documentElement.style.setProperty('--sExW_zIndex', "1");
                sExZ = 1
                windowDragged = 2
                document.documentElement.style.setProperty('--sGrW_zIndex', "auto");
                sGrZ = 0
            }

            if (mouseX >= sViewX && mouseX <= sViewX + 600 && mouseY >= sViewY && mouseY <= sViewY + 600 && windowDragged === 0 || windowDragged === 1) { // Updates drag for sView
                sViewX = mouseX - sVeXMouseGap;
                sViewY = mouseY - sVeYMouseGap;


                // Z handler
                document.documentElement.style.setProperty('--sGrW_zIndex', "1");
                sGrZ = 1
                windowDragged = 1
                document.documentElement.style.setProperty('--sExW_zIndex', "auto");
                sExZ = 0
            }

            if (mouseX >= sExX && mouseX <= sExX + 600 && mouseY >= sExY && mouseY <= sExY + 600 && windowDragged === 0 || windowDragged === 2) { // Updates drag for sEx
                sExX = mouseX - sExXMouseGap;
                sExY = mouseY - sExYMouseGap;


                document.documentElement.style.setProperty('--sExW_zIndex', "1");
                sExZ = 1
                windowDragged = 2
                document.documentElement.style.setProperty('--sGrW_zIndex', "auto");
                sGrZ = 0
            }

            // Moves windows

            document.documentElement.style.setProperty('--sView_xPos', sViewX + "px");
            document.documentElement.style.setProperty('--sView_yPos', sViewY + "px");

            document.documentElement.style.setProperty('--sEx_xPos', sExX + "px");
            document.documentElement.style.setProperty('--sEx_yPos', sExY + "px");


        } else {

            // Resets windowDragged
            windowDragged = 0

            // Updates gaps

            sVeXMouseGap = mouseX - sViewX;
            sVeYMouseGap = mouseY - sViewY;
            sExXMouseGap = mouseX - sExX;
            sExYMouseGap = mouseY - sExY;

        }

        // Update Positions
        document.getElementById('test1').innerHTML = mouseDown; // Check for mouse activity (dev)
        document.getElementById('test2').innerHTML = mouseX + " " + mouseY; // Check for mouse activity (dev)
    }
    function elapseTime() {
        ticks += 1 // Elapses time
        if (ticks % 100 === 0) {
            hour += 1
            slowThread();
        }
    }
    function thread() { // Game loop
        elapseTime(); // Timing
        test(); // Tests loop activity
        updateWindowPositions();

        setTimeout(function(){ thread(); }, 15); // Loops tick
    }

    function slowThread() {
        updateGraphAndDisplay();
    }

    thread() // Initiate game

</script>
{% endblock %}

<!- This is turning off birds background from base.html -->
{% block background %}
{% endblock %}